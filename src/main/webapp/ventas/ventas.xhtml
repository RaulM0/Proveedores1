<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Ventas - Registro de Pedido</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <h:outputStylesheet library="css" name="pagos.css" />
    <h:outputStylesheet library="css" name="estilos.css" />
    <h:outputStylesheet library="css" name="dashboard.css" />
    <h:outputStylesheet name="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</h:head>

<h:body>
    <div class="navbar">
        <div class="navbar-brand">
            <span class="brand-icon">üè¢</span>
            <span class="brand-name">Sistema de Gesti√≥n Proveedores</span>
            <a href="../dashboard.xhtml" class="btn-volver">Inicio</a>
        </div>
        <div class="navbar-menu">
            <div class="user-menu">
                <span class="user-icon">üë§</span>
                <span class="user-name">#{sessionBean.nombreUsuario}</span>
            </div>
        </div>
    </div>

    <div class="main-container">
        
        <f:metadata>
            <f:viewAction action="#{ventaBean.inicializarVenta}" onPostback="false"/>
        </f:metadata>
        
        <h:form id="formVenta">
            
            <h1 style="margin-bottom: 20px;">Registro de Nueva Venta</h1>
            
            <p:growl id="growl" showDetail="true" />
    
            <p:panelGrid columns="2" layout="grid" styleClass="ui-panelgrid-blank">
                
                <p:column style="width: 40%;">
                    <p:card styleClass="filters-card"> 
                        <f:facet name="title">
                            <h:outputText value="1. A√±adir Productos" />
                        </f:facet>
                        
                        <p:panelGrid columns="3" layout="grid" styleClass="ui-panelgrid-blank">
                            <p:inputText value="#{ventaBean.productoABuscarId}" 
                                         placeholder="C√≥digo o Nombre del Producto" />
                            
                            <p:commandButton value="Buscar" icon="pi pi-search" 
                                             action="#{ventaBean.buscarProducto}" 
                                             update="growl productoDetalle" />
                            
                            <p:commandButton value="Limpiar" icon="pi pi-times" 
                                             action="#{ventaBean.limpiarDetalleAuxiliar}"
                                             update="growl productoDetalle" 
                                             process="@this" immediate="true" />
                        </p:panelGrid>
                        
                        <p:separator/>
                        
                        <p:panel id="productoDetalle" header="Detalle de Art√≠culo" 
                                 rendered="#{ventaBean.detalleAuxiliar.productoId != null}">
                            
                            <p:panelGrid columns="2" layout="grid">
                                <h:outputText value="Fecha Venta:" />
                                <h:outputText value="#{ventaBean.nuevaVenta.fechaVenta}">
                                    <f:convertDateTime pattern="dd/MM/yyyy HH:mm"/>
                                </h:outputText>
                                
                                <h:outputText value="Estado:" />
                                <h:outputText value="#{ventaBean.nuevaVenta.status}" style="font-weight: bold;"/>
                                
                                <h:outputText value="Usuario ID:" />
                                <h:outputText value="#{ventaBean.nuevaVenta.usuarioId}" />
                            </p:panelGrid>
                            
                            <p:separator/>
                            
                            <p:panelGrid columns="2" layout="grid">
                                <h:outputText value="Nombre:" />
                                <h:outputText value="#{ventaBean.detalleAuxiliar.nombre}" style="font-weight: bold;"/>
                                
                                <h:outputText value="Precio Unitario:" />
                                <h:outputText value="#{ventaBean.detalleAuxiliar.precioUnitario}" >
                                    <f:convertNumber type="currency" currencySymbol="$" locale="es_MX"/>
                                </h:outputText>
                                
                                <h:outputText value="Cantidad:" />
                                <p:inputNumber value="#{ventaBean.detalleAuxiliar.cantidad}" 
                                               minValue="1" 
                                               decimalPlaces="0"
                                               required="true" 
                                               requiredMessage="Ingrese cantidad." />
                            </p:panelGrid>
                            
                            <p:separator/>
                            
                            <p:commandButton value="Agregar a Venta" icon="pi pi-plus" 
                                             action="#{ventaBean.agregarProductoALaVenta}" 
                                             update=":formVenta:productosTabla :formVenta:resumenVenta growl productoDetalle" 
                                             style="width:100%;" />
                        </p:panel>
                    </p:card>
                </p:column>
                
                <p:column style="width: 60%;">
                    <p:card styleClass="payments-card">
                        <f:facet name="title">
                            <h:outputText value="2. Resumen y Pago" />
                        </f:facet>
                        
                        <p:dataTable id="productosTabla" var="detalle" value="#{ventaBean.nuevaVenta.detalle}" 
                                     emptyMessage="No hay productos en la lista." 
                                     styleClass="payments-table">
                            <p:column headerText="#">
                                <h:outputText value="#{rowIndex + 1}" />
                            </p:column>
                            <p:column headerText="Producto" style="width: 35%;">
                                <h:outputText value="#{detalle.nombre}" />
                            </p:column>
                            
                            <p:column headerText="Cant.">
                                <p:inputNumber value="#{detalle.cantidad}" minValue="1" decimalPlaces="0">
                                    <p:ajax event="blur" listener="#{ventaBean.calcularTotales}" 
                                            update=":formVenta:resumenVenta" />
                                </p:inputNumber>
                            </p:column>
                            
                            <p:column headerText="Precio Unitario">
                                <h:outputText value="#{detalle.precioUnitario}" >
                                    <f:convertNumber type="currency" currencySymbol="$" locale="es_MX"/>
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Subtotal">
                                <h:outputText value="#{detalle.subtotal}" >
                                    <f:convertNumber type="currency" currencySymbol="$" locale="es_MX"/>
                                </h:outputText>
                            </p:column>
                            
                            <p:column headerText="Acci√≥n">
                                <p:commandButton icon="pi pi-trash" title="Eliminar" styleClass="ui-button-danger"
                                                 action="#{ventaBean.eliminarProducto(detalle)}"
                                                 update="productosTabla :formVenta:resumenVenta growl" />
                            </p:column>
                        </p:dataTable>
                        
                        <p:separator/>
                        
                        <p:panelGrid id="resumenVenta" columns="2" layout="grid" styleClass="ui-panelgrid-footer">
                            <f:facet name="header">Totales (Refleja el campo 'total' de la BD)</f:facet>
                            
                            <h:outputText value="Subtotal:" style="font-weight: bold;"/>
                            <h:outputText value="#{ventaBean.subtotal}" style="font-weight: bold;">
                                <f:convertNumber type="currency" currencySymbol="$" locale="es_MX"/>
                            </h:outputText>
                            
                            <h:outputText value="IVA (16%):" style="font-weight: bold;"/>
                            <h:outputText value="#{ventaBean.iva}" style="font-weight: bold;">
                                <f:convertNumber type="currency" currencySymbol="$" locale="es_MX"/>
                            </h:outputText>
                            
                            <h:outputText value="TOTAL:" style="font-size: 1.2em; color: var(--status-rechazado); font-weight: bold;"/>
                            <h:outputText value="#{ventaBean.total}" style="font-size: 1.2em; color: var(--status-rechazado); font-weight: bold;">
                                <f:convertNumber type="currency" currencySymbol="$" locale="es_MX"/>
                            </h:outputText>
                            
                            <p:outputLabel for="montoPagadoInput" value="Monto Pagado:" style="font-weight: bold;"/>
                            <p:inputNumber id="montoPagadoInput" value="#{ventaBean.montoPagado}" 
                                           symbol="$" 
                                           required="true" 
                                           requiredMessage="Ingrese monto pagado.">
                                <p:ajax event="blur" listener="#{ventaBean.calcularTotales}" 
                                        update="resumenVenta" />
                            </p:inputNumber>
                            
                            <h:outputText value="Cambio:" style="font-size: 1.2em; color: #4CAF50; font-weight: bold;"/>
                            <h:outputText value="#{ventaBean.cambio}" style="font-size: 1.2em; color: #4CAF50; font-weight: bold;">
                                <f:convertNumber type="currency" currencySymbol="$" locale="es_MX"/>
                            </h:outputText>
                            
                            <f:facet name="footer">
                                <p:commandButton value="Registrar Venta" icon="pi pi-check" 
                                                 action="#{ventaBean.registrarVenta}" 
                                                 update=":formVenta:growl productosTabla resumenVenta" 
                                                 styleClass="btn btn-confirm" style="width:100%; margin-top: 10px;" />
                            </f:facet>
                        </p:panelGrid>
                    </p:card>
                </p:column>

            </p:panelGrid>
            
        </h:form>

    </div>
</h:body>
</html>