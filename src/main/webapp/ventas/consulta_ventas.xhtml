<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Consulta de Ventas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- âœ… Usa tus hojas locales -->
    <h:outputStylesheet library="css" name="dashboard.css" />
    <h:outputStylesheet library="css" name="estilos.css" />
</h:head>

<h:body style="background-color:#f5f6f7;">
    <!-- ðŸ”¹ Barra superior -->
    <div class="navbar">
        <div class="navbar-brand">
            <span class="brand-icon">ðŸ’¼</span>
            <span class="brand-name">Sistema de GestiÃ³n Proveedores</span>
            <a href="../dashboard.xhtml" class="btn-volver">Inicio</a>
        </div>
        <div class="navbar-menu">
            <div class="user-menu">
                <span class="user-icon">ðŸ‘¤</span>
                <span class="user-name">#{sessionBean.nombreUsuario}</span>
            </div>
        </div>
    </div>

    <!-- ðŸ”¹ Contenedor principal -->
    <div class="main-container" style="padding:25px;">

        <h:form id="formConsulta">

            <h1 style="margin-bottom:20px;">Historial de Ventas</h1>
            <p:growl id="growl" showDetail="true" />

            <!-- ðŸ”¹ Filtros -->
            <p:card style="margin-bottom:20px;">
                <f:facet name="title">Filtros de bÃºsqueda</f:facet>

                <p:panelGrid columns="4" layout="grid" styleClass="ui-panelgrid-blank" style="width:100%;">
                    <p:outputLabel for="folio" value="Folio:" />
                    <p:inputText id="folio" value="#{consultaVentasBean.folioBusqueda}" placeholder="Ej: V-2025-0001" />

                    <p:outputLabel for="estado" value="Estado:" />
                    <p:selectOneMenu id="estado" value="#{consultaVentasBean.estadoFiltro}">
                        <f:selectItem itemLabel="Todos" itemValue="" />
                        <f:selectItem itemLabel="Completada" itemValue="Completada" />
                        <f:selectItem itemLabel="Pendiente" itemValue="Pendiente" />
                        <f:selectItem itemLabel="Cancelada" itemValue="Cancelada" />
                    </p:selectOneMenu>

                    <p:outputLabel for="fechaInicio" value="Fecha desde:" />
                    <p:calendar id="fechaInicio" value="#{consultaVentasBean.fechaInicio}" pattern="dd/MM/yyyy" showOn="button" />

                    <p:commandButton value="Buscar" icon="pi pi-search"
                                     action="#{consultaVentasBean.buscarVentas}"
                                     update="tablaVentas growl"
                                     style="margin-top:20px; background:#007ad9; color:white; border:none;" />
                </p:panelGrid>
            </p:card>

            <!-- ðŸ”¹ Tabla de ventas -->
            <p:card>
                <f:facet name="title">Resultados de Ventas</f:facet>

                <p:dataTable id="tablaVentas" var="venta" value="#{consultaVentasBean.listaVentas}"
                             paginator="true" rows="10" responsiveLayout="scroll"
                             emptyMessage="No hay ventas registradas."
                             style="width:100%;">

                    <p:column headerText="Folio" sortBy="#{venta.folio_venta}">
                        <h:outputText value="#{venta.folio_venta}" />
                    </p:column>

                    <p:column headerText="Fecha" sortBy="#{venta.fecha_venta}">
                        <h:outputText value="#{venta.fecha_venta}">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Usuario" style="text-align:center;">
                        <h:outputText value="#{venta.usuario_id}" />
                    </p:column>

                    <p:column headerText="Total" style="text-align:right;">
                        <h:outputText value="#{venta.total}">
                            <f:convertNumber type="currency" currencySymbol="$" locale="es_MX" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Estado" style="text-align:center;">
                        <h:outputText value="#{venta.status}" />
                    </p:column>

                    <p:column headerText="Acciones" style="text-align:center;">
                        <p:commandButton value="Ver Detalle"
                                         icon="pi pi-eye"
                                         styleClass="ui-button-secondary"
                                         actionListener="#{consultaVentasBean.verDetalle(venta)}"
                                         update=":formConsulta:dlgDetalle"
                                         oncomplete="PF('dlgDetalle').show();" />
                    </p:column>
                </p:dataTable>
            </p:card>

            <!-- ðŸ”¹ DiÃ¡logo de detalle -->
            <p:dialog id="dlgDetalle" widgetVar="dlgDetalle"
                      header="Detalle de Venta" modal="true" width="700" closable="true">

                <p:panelGrid columns="2" style="width:100%;" cellpadding="5">
                    <h:outputText value="Folio:" />
                    <h:outputText value="#{consultaVentasBean.ventaSeleccionada.folio_venta}" />

                    <h:outputText value="Fecha:" />
                    <h:outputText value="#{consultaVentasBean.ventaSeleccionada.fecha_venta}">
                        <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                    </h:outputText>

                    <h:outputText value="Usuario:" />
                    <h:outputText value="#{consultaVentasBean.ventaSeleccionada.usuario_id}" />

                    <h:outputText value="Total:" />
                    <h:outputText value="#{consultaVentasBean.ventaSeleccionada.total}">
                        <f:convertNumber type="currency" currencySymbol="$" locale="es_MX" />
                    </h:outputText>
                </p:panelGrid>

                <p:separator/>

                <p:dataTable var="detalle" value="#{consultaVentasBean.ventaSeleccionada.detalle}"
                             emptyMessage="Sin productos." style="width:100%;">
                    <p:column headerText="Producto">
                        <h:outputText value="#{detalle.nombre}" />
                    </p:column>

                    <p:column headerText="Cantidad" style="text-align:center;">
                        <h:outputText value="#{detalle.cantidad}" />
                    </p:column>

                    <p:column headerText="Precio Unitario" style="text-align:right;">
                        <h:outputText value="#{detalle.precio_unitario}">
                            <f:convertNumber type="currency" currencySymbol="$" locale="es_MX" />
                        </h:outputText>
                    </p:column>

                    <p:column headerText="Subtotal" style="text-align:right;">
                        <h:outputText value="#{detalle.subtotal}">
                            <f:convertNumber type="currency" currencySymbol="$" locale="es_MX" />
                        </h:outputText>
                    </p:column>
                </p:dataTable>

                <p:separator/>
                <p:commandButton value="Cerrar" icon="pi pi-times"
                                 onclick="PF('dlgDetalle').hide(); return false;"
                                 style="width:100%; background:#007ad9; color:white; border:none;" />
            </p:dialog>
        </h:form>
    </div>
</h:body>
</html>
